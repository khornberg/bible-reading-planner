function getSkippedDays(){var a=[];return $("#skip-checkboxes input:checked").each(function(b,c){a.push(c.value)}),a}function showError(a){var b='<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>'+a+"</strong></div>";$("#wait").hide(),$("div .alert").remove(),$("#wait").parent().append(b),document.getElementById("wait").scrollIntoView()}function getPlanData(){var a={};if(a.sequenceName=$(".list-group-item.active").attr("name"),!a.sequenceName)throw"Choose a sequence.";if(a.begin=$("#calendar-start").datepicker("getDate"),a.begin[0])throw"Choose a start date.";if(a.end=$("#calendar-end").datepicker("getDate"),a.end[0])throw"Choose an end date.";var b=[];if($("#skip-checkboxes input:checked").each(function(a,c){b.push(Number(c.value))}),a.skip=b,a.kind=$("#type :radio:checked").attr("id"),a.amount=$("#amountNumber").val(),!a.kind)throw"Choose an amount to read.";if("verses"===a.kind&&!a.amount)throw"Specify the number of verses per day you want to read.";if("undefined"===a.kind)throw"Choose to whether or not to read some verses, the whole plan, or just what fits in your day.";return console.log("Data "+JSON.stringify(a)),a}function output(a,b){switch(b){case"pdf":case"text":case"markdown":case"ical":console.error("Not implemented yet.");break;case"dom":for(var c="",d=0;d<a.length;d++){c=c+"<tr><td>"+a[d].day+"</td><td>";for(var e=0;e<a[d].refs.length;e++)if("string"==typeof a[d].refs[e])c+=a[d].refs[e],e<a[d].refs.length-1&&(c+=", ");else for(var f=0;f<a[d].refs[e].length;f++)c+=a[d].refs[e][f],f<a[d].refs[e].length-1&&(c+=", ");c+="</td></tr>"}return c}}function assembleUri(){var a="",b=planner.amount?planner.amount:planner.kind;return a+="p="+planner.sequence.abbv+"&",a+="s="+(planner.begin.getMonth()+1)+"/"+planner.begin.getDate()+"/"+planner.begin.getFullYear()+"&",a+="e="+(planner.end.getMonth()+1)+"/"+planner.end.getDate()+"/"+planner.end.getFullYear()+"&",a+="k=["+planner.skip.toString()+"]&",a+="a="+b,console.log(a),a}function compressUri(){var a=LZString.compressToBase64(assembleUri()).replace("=","$").replace("/","-");return a}function getUriData(){function a(a){return/^\s*$/.test(a)?null:/^(true|false)$/i.test(a)?"true"===a.toLowerCase():isFinite(a)?parseFloat(a):isFinite(Date.parse(a))?new Date(a):/^\[.*\]$/.test(a)?JSON.parse(a):a}var b={};if(window.location.search.length>1){var c=LZString.decompressFromBase64(window.location.search.substr(1)).replace("$","=").replace("-","/");console.log(c||!1);for(var d,e=0,f=c.split("&");e<f.length;e++)d=f[e].split("="),b[unescape(d[0])]=d.length>1?a(unescape(d[1])):null}return b}function isValidPlan(a){var b=[];return $(".list-group-item").each(function(){b.push($(this).attr("data-abbv"))}),-1===b.indexOf(a.p)?!1:isFinite(Date.parse(a.s))&&isFinite(Date.parse(a.e))&&Array.isArray(a.k)&&($.isNumeric(a.a)||"partial"===a.a||"whole"===a.a)?!0:!1}function updateLinks(){$("#fb").attr("href","http://www.facebook.com/sharer.php?u="+window.location.href),$("#tw").attr("href","http://twitter.com/share?url="+window.location.href+"&Bible Reading Plan"),$("#gp").attr("href","https://plus.google.com/share?url="+window.location.href),$("#li").attr("href","http://www.linkedin.com/shareArticle?mini=true&url="+window.location.href)}function getStartDate(){var a=new Date,b=a.getFullYear();return new Date(b,0,1)}var planner={sequence:null,sequenceName:null,begin:null,end:null,skip:null,amount:null,kind:null,duration:null,plan:null,create:function(){"use strict";if("verses"===this.kind){var a=Number(this.amount)>0?Number(this.amount):1;this.plan=this.createVersesPlan(this.sequence,a)}("whole"===this.kind||"partial"===this.kind)&&(this.plan=this.createSpecifiedPlan(this.sequence,this.kind),this.amount=null)},createSpecifiedPlan:function(a,b){"use strict";var c=Math.floor(a.data2.length/this.duration.length);c=0===c?1:c;var d=a.data2.length%this.duration.length,e=[],f=0;if("whole"===b)for(var g=0;g<this.duration.length;g++){for(var h=[],i=0;c>i;i++)if(f<a.data2.length){for(var j=0;j<a.data2[f].length;j++)h.push(bible.parseReference(a.data2[f][j]).toString());if(f++,d>0){for(var k=0;k<a.data2[f].length;k++)h.push(bible.parseReference(a.data2[f][k]).toString());f++,d--}}if(e.push({day:this.duration[g].toString(),refs:h}),f===a.data2.length)break}if("partial"===b)for(var l=this.duration.length<a.data2.length?this.duration.length:a.data2.length,m=0;l>m;m++){for(var n="",o=0;o<a.data2[m].length;o++){var p=o>0?", ":"";n+=p+bible.parseReference(a.data2[m][o]).toString()}e.push({day:this.duration[m].toString(),refs:[n.trim()]})}return e},createVersesPlan:function(a,b){"use strict";for(var c,d=0,e="",f=[],g=[],h=[],i=0;d<a.data.length;){if((null===c||void 0===c)&&(c=bible.parseReference(a.data[d]),c.chapter1>=0&&-1===c.verse1&&-1===c.verse2)){c.chapter2=-1===c.chapter2?c.chapter1:c.chapter2;var j=-1===c.chapter2?c.chapter1-1:c.chapter2-1;c.verse2=bible.Books[c.bookIndex].verses[j],c.verse1=1}if(c.isValid()){var k=null!==c?bible.distance(c).verses:0,l=i>0?i:b;if(k>=l){var m=-1===c.verse1?1:c.verse1,n=bible.Reference(c.bookIndex,c.chapter1,m),o=n.toString(),p=bible.add(n,l-1),q=p.toString(),r=null;if(o!==q)if(n.bookIndex===p.bookIndex){var s=n.chapter1===p.chapter1?"":p.chapter1+":";r=o+"-"+s+p.verse1}else r=o+"-"+q;else r=o;h.push(r),g.push(h),h=[],bible.add(c,l),(c.chapter1>c.chapter2||c.chapter1===c.chapter2&&c.verse1>c.verse2)&&(console.error("Reversed: "+c),c=null,d++),i=0}else h.push(c.toString()),i=l-k,c=null,d++}else void 0!==a.data[d]&&(console.error("invalid reference: "+a.data[d]+" key: "+d+" sequence: "+a.name),g.push("Sorry there was an error parsing "+a.data[d]+"."),c=null,d++)}""!==e&&g.push(e);for(var t=0;t<this.duration.length;t++)void 0!==g[t]&&f.push({day:this.duration[t],refs:[g[t]]});return f},load:function(){"use strict";var a=arguments.length>=1?arguments[0]:this.sequenceName,b=arguments.length>=2?arguments[1]:READING_PLANS,c=null;a&&$.ajax({dataType:"json",url:b+"/"+a,async:!1,success:function(a){c=a},error:function(a){throw a}}),this.sequence=c},set:function(a){"use strict";this.sequenceName=a.sequenceName,this.begin=a.begin,this.end=a.end,this.skip=a.skip,this.amount=a.amount,this.kind=a.kind,this.duration=time(this.begin,this.end,this.skip),this.load()}},time=function(a,b,c){"use strict";for(var d=moment(a),e=moment(b),f=d.twix(e,!0),g=f.iterate("days"),h=0,i=[];h<f.count("days");){var j=g.next();c.indexOf(j.day())<0&&i.push(j.format("MMMM Do, YYYY")),h++}return i};console.groupCollapsed("App tests"),console.log("Running jQuery %s",$().jquery),console.log(bible);var ref=bible.parseReference("rom 1:4");console.log(bible.add(ref,10).toString()),console.log("LZString: "+typeof LZString!="undefined"),console.log("moment: "+typeof moment!="undefined"),console.log("ics: "+typeof ics!="undefined"),console.groupEnd();var BASE_URL=window.location.origin+window.location.pathname,READING_PLANS=BASE_URL+"bower_components/readingplans",FILENAME="BibleReadingPlan",SEPARATOR=-1!==navigator.appVersion.indexOf("Win")?"\r\n":"\n",uriData=getUriData();$(".list-group-item").each(function(){$(this).attr("data-abbv")===uriData.p&&$(this).addClass("active")}),$("#calendar-start").datepicker({todayHighlight:!0,startDate:getStartDate()}),$("#calendar-start").datepicker("update","undefined"!=typeof uriData.s?uriData.s:new Date),$("#calendar-end").datepicker({todayHighlight:!0,startDate:new Date});var initEndDate=null;"undefined"!=typeof uriData.e?initEndDate=uriData.e:(initEndDate=new Date,initEndDate.setDate(initEndDate.getDate()+30)),$("#calendar-end").datepicker("update",initEndDate),$("#calendar-start").change(function(){$("#calendar-end").datepicker("setStartDate",$("#calendar-start").datepicker("getDate"))}),$("#calendar-end").change(function(){$("#calendar-start").datepicker("setEndDate",$("#calendar-end").datepicker("getDate"))}),"undefined"!=typeof uriData.k&&uriData.k.length>0&&($("#calendar-start").datepicker("setDaysOfWeekDisabled",uriData.k),$("#calendar-end").datepicker("setDaysOfWeekDisabled",uriData.k),$("#skip-checkboxes input").each(function(a,b){-1!==uriData.k.indexOf(Number(b.value))&&$(this).parent().addClass("active")})),$("#skip-checkboxes").change(function(){$("#calendar-start").datepicker("setDaysOfWeekDisabled",getSkippedDays()),$("#calendar-end").datepicker("setDaysOfWeekDisabled",getSkippedDays())}),"undefined"!=typeof uriData.a&&("partial"===uriData.a?($("#amountNumber").hide(),$("#partial").parent().addClass("active"),$("#partial").prop("checked",!0),$("#specified").parent().addClass("active"),$("#specified").prop("checked",!0)):"whole"===uriData.a?($("#amountNumber").hide(),$("#whole").parent().addClass("active"),$("#whole").prop("checked",!0),$("#specified").parent().addClass("active"),$("#specified").prop("checked",!0)):($("#amountNumber").show().val(uriData.a),$("#verses").parent().addClass("active"),$("#verses").prop("checked",!0))),$("#type input[type=radio]").change(function(){"verses"===this.id?$("#amountNumber").show():$("#amountNumber").hide()}),$(".list-group-item").click(function(){$(".list-group-item").each(function(){$(this).removeClass("active")}),$(this).addClass("active"),planner.sequenceName=$(".list-group-item.active").attr("name"),planner.load();var a="<p><b>Day 1:</b> "+planner.sequence.data2[0],b="<br /><b>Day 2:</b> "+planner.sequence.data2[1]+"</p>",c="<p><b>Days:</b> "+planner.sequence.data2.length+"<br /><b>Readings:</b> "+planner.sequence.data.length,d=planner.sequence.info+"<br /><br />Excerpt from the original sequence:"+a+b+c;$(".panel-sequence").html(d)}),$("#sequence").click(function(a){a.preventDefault()}),$("#legal").click(function(a){a.preventDefault(),$(".legal").toggle(),document.getElementById("legal").scrollIntoView()}),$("#create").click(function(){try{$(".alert").remove();var a=getPlanData();planner.set(a),planner.create();var b=output(planner.plan,"dom");b&&$("tbody").children().remove(),$("tbody").append(b),$(".plan").css("display","block"),document.getElementById("plan").scrollIntoView(),window.history.pushState({},"Create Bible Reading Plan",window.location.pathname+"?"+compressUri()),updateLinks(),$("#downloads h2").text("Your customized "+planner.sequence.name+" plan")}catch(c){console.error(c),showError(404===c.status?"Error getting the plan file.":c)}}),$("#save").click(function(a){a.preventDefault(),$(".save a").toggle()}),$("#share").click(function(a){a.preventDefault(),$(".share a").toggle()}),$("#downloadText").click(function(a){a.preventDefault();var b="";$("tbody tr").each(function(a,c){b+=c.cells[0].innerText+": "+c.cells[1].innerText+SEPARATOR});var c=new Blob([b],{type:"text/plain;charset=utf-8"});saveAs(c,FILENAME+".txt")}),$("#downloadMarkdown").click(function(a){a.preventDefault();var b="";$("tbody tr").each(function(a,c){b+="**"+c.cells[0].innerText+"**: "+c.cells[1].innerText+SEPARATOR});var c=new Blob([b],{type:"text/plain;charset=utf-8"});saveAs(c,FILENAME+".md")}),$("#downloadIcs").click(function(a){a.preventDefault();var b=ics();$("tbody tr").each(function(a,c){var d=moment(c.cells[0].innerText,"MMMM DD, YYYY"),e=moment(d).format("YYYY/MM/DD"),f=moment(d).add("d",1).format("YYYY/MM/DD"),g=c.cells[1].innerText,h=g.length<70?g:"Bible Reading",i="Your Bible";b.addEvent(h,g,i,e,f)}),b.download(FILENAME)}),$("#emailText").click(function(a){$("#emailText").attr("href","mailto:?Subject=Bible Reading Plan&Body=My bible reading plan: "+window.location.href)}),isValidPlan(uriData)&&(console.log(isValidPlan(uriData)),$("#create").trigger("click"));