"use strict";function getSkippedDays(){var a=[];return $("#skip-checkboxes input:checked").each(function(b,c){a.push(c.value)}),a}function setSequences(a){$.getJSON(READING_PLANS+"/"+a).done(function(b){var c="undefined"==typeof b.data2?b.data.length:b.data2.length,d='<a href="#" class="list-group-item" name="'+a+'">'+b.name+'<span class="badge">'+c+" days</span></a>";$("#sequence").append(d),$(".list-group-item").click(function(){$(".list-group-item").each(function(){$(this).removeClass("active")}),$(this).addClass("active")})})}function showError(a){var b='<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>'+a+"</strong></div>";$("#wait").hide(),$("div .alert").remove(),$("#wait").parent().append(b),document.getElementById("wait").scrollIntoView()}function getPlannerData(){var a={};a.sequenceName=$(".list-group-item.active").attr("name"),a.begin=$("#calendar-start").datepicker("getDate"),a.end=$("#calendar-end").datepicker("getDate");var b=[];return $("#skip-checkboxes input:checked").each(function(a,c){b.push(Number(c.value))}),a.skip=b,a.type=$("#type :radio:checked").attr("id"),a.amount="specified"===a.type?$("#amountSpecified :radio:checked").attr("id"):$("#amountNumber").val(),console.info("Data "+JSON.stringify(a)),a}function output(a,b){switch(b){case"pdf":case"text":case"markdown":case"ical":console.error("Not implemented yet.");break;case"dom":for(var c="",d=0;d<a.length;d++){c=c+"<tr><td>"+a[d].day+"</td><td>";for(var e=0;e<a[d].refs.length;e++)c+=a[d].refs[e],e<a[d].refs.length-1&&(c+=", ");c+="</td></tr>"}return c}}console.groupCollapsed("App tests"),console.log("Running jQuery %s",$().jquery),console.log(bible);var ref=bible.parseReference("rom 1:4");console.log(bible.add(ref,10).toString()),console.groupEnd();var READING_PLANS="../bower_components/readingplans",FILENAME="BibleReadingPlan",SEPARATOR=-1!==navigator.appVersion.indexOf("Win")?"\r\n":"\n";$.ajax({url:READING_PLANS,type:"GET"}).done(function(a){var b=[];$(a).find("a:contains(.json)").each(function(){b.push($(this).attr("title"))});for(var c=0;c<b.length;c++)setSequences(b[c])}).fail(function(){console.error("error loading bible reading plan");var a='<a href="" class="list-group-item">Error Loading Plans</a>';$("#sequence").append(a)}),$("#calendar-start").datepicker({todayHighlight:!0,startDate:new Date}),$("#calendar-start").datepicker("update",new Date),$("#calendar-end").datepicker({todayHighlight:!0,startDate:new Date});var initEndDate=new Date;initEndDate.setDate(initEndDate.getDate()+30),$("#calendar-end").datepicker("update",initEndDate),$("#calendar-start").change(function(){$("#calendar-end").datepicker("setStartDate",$("#calendar-start").datepicker("getDate"))}),$("#calendar-end").change(function(){$("#calendar-start").datepicker("setEndDate",$("#calendar-end").datepicker("getDate"))}),$("#skip-checkboxes").change(function(){$("#calendar-start").datepicker("setDaysOfWeekDisabled",getSkippedDays()),$("#calendar-end").datepicker("setDaysOfWeekDisabled",getSkippedDays())}),$("#type input[type=radio]").change(function(){"specified"===this.id?($("#amountNumber").hide(),$("#amountSpecified").show()):($("#amountNumber").show(),$("#amountSpecified").hide())}),$("#sequence").click(function(a){a.preventDefault()}),$("#legal").click(function(a){a.preventDefault(),$(".legal").show()}),$("#create").click(function(){$("#wait").show();var a,b={lines:13,length:15,width:5,radius:15,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:40,shadow:!1,hwaccel:!1,className:"spinner"},c=document.getElementById("wait");c.firstElementChild||(a=new Spinner(b).spin(c));try{$(".alert").remove();var d=getPlannerData();planner.set(d),planner.create();var e=output(planner.plan,"dom");a.stop(),$("#wait").hide(),e&&$("tbody").children().remove(),$("tbody").append(e),$(".plan").addClass("fade"),document.getElementById("plan").scrollIntoView()}catch(f){console.error(f),a.stop(),showError(f)}}),$("#downloadText").click(function(a){a.preventDefault();var b="";$("tbody tr").each(function(a,c){b+=c.cells[0].innerText+": "+c.cells[1].innerText+SEPARATOR});var c=new Blob([b],{type:"text/plain;charset=utf-8"});saveAs(c,FILENAME+".txt")}),$("#downloadMarkdown").click(function(a){a.preventDefault();var b="";$("tbody tr").each(function(a,c){b+="**"+c.cells[0].innerText+"**: "+c.cells[1].innerText+SEPARATOR});var c=new Blob([b],{type:"text/plain;charset=utf-8"});saveAs(c,FILENAME+".md")}),$("#downloadIcs").click(function(a){a.preventDefault(),$.getScript("/scripts/ics.js").done(function(){var a=ics();$("tbody tr").each(function(b,c){var d=moment(c.cells[0].innerText,"MMMM DD, YYYY"),e=moment(d).format("YYYY/MM/DD"),f=moment(d).add("d",1).format("YYYY/MM/DD"),g=c.cells[1].innerText,h="Bible Reading",i="Your Bible";a.addEvent(h,g,i,e,f)}),a.download(FILENAME)}).fail(function(a){showError(a),console.log(a)})});var planner={sequence:null,sequenceName:null,begin:null,end:null,skip:null,amount:null,type:null,duration:null,plan:null,create:function(){if("verses"===this.type){var a=Number(this.amount)>0?Number(this.amount):1;this.plan=this.createVersesPlan(this.sequence,a)}"specified"===this.type&&(this.plan=this.createSpecifiedPlan(this.sequence,this.amount))},createSpecifiedPlan:function(a,b){var c=Math.floor(a.data2.length/this.duration.length);c=0===c?1:c;var d=a.data2.length%this.duration.length,e=[],f=0;if("whole"===b)for(var g=0;g<this.duration.length;g++){for(var h=[],i=0;c>i;i++)if(f<a.data2.length){for(var j=0;j<a.data2[f].length;j++)h.push(bible.parseReference(a.data2[f][j]).toString());if(f++,d>0){for(var k=0;k<a.data2[f].length;k++)h.push(bible.parseReference(a.data2[f][k]).toString());f++,d--}}if(e.push({day:this.duration[g].toString(),refs:h}),f===a.data2.length)break}if("partial"===b)for(var l=this.duration.length<a.data2.length?this.duration.length:a.data2.length,m=0;l>m;m++){for(var n="",o=0;o<a.data2[m].length;o++){var p=o>0?", ":"";n+=p+bible.parseReference(a.data2[m][o]).toString()}e.push({day:this.duration[m].toString(),refs:[n.trim()]})}return e},createVersesPlan:function(a,b){for(var c,d=0,e="",f=[],g=[];d<a.data.length;)if(void 0===c&&(c=bible.parseReference(a.data[d]),console.info(c.toString())),c.isValid()){var h=void 0!==c?bible.distance(c).verses:void 0,i=""!==e?bible.distance(bible.parseReference(e)).verses:"",j=""!==e?b-i:b;if(h>=j){var k=bible.Reference(c.bookIndex,c.chapter1,-1===c.verse1?1:c.verse1),l=k.toString(),m=bible.add(k,j-1).toString(),n=""!==e?e+"; "+l+"-"+m:l+"-"+m;g.push(n),bible.add(c,j),e=""}else e=""===e?c.toString():e+"; "+c.toString(),c=void 0,d++}else void 0!==a.data[d]&&(console.error("invalid reference: "+a.data[d]+" key: "+d),g.push("Sorry there was an error parsing "+a.data[d]+"."),c=void 0,d++);""!==e&&g.push(e);for(var o=0;o<this.duration.length;o++)void 0!==g[o]&&f.push({day:this.duration[o],refs:[g[o]]});return f},load:function(){var a="";$.ajax({dataType:"json",url:READING_PLANS+"/"+this.sequenceName,async:!1,success:function(b){a=b},error:function(a){throw a}}),this.sequence=a},set:function(a){this.sequenceName=a.sequenceName,this.begin=a.begin,this.end=a.end,this.skip=a.skip,this.amount=a.amount,this.type=a.type,this.duration=time(this.begin,this.end,this.skip),this.load()}},time=function(a,b,c){for(var d=moment(a),e=moment(b),f=d.twix(e,!0),g=f.iterate("days"),h=0,i=[];h<f.count("days");){var j=g.next();c.indexOf(j.day())<0&&i.push(j.format("MMMM Do, YYYY")),h++}return i};